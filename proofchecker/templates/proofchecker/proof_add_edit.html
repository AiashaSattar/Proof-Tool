{% extends 'proofchecker/base.html' %}
{% load static %}
{% block content %}
     <style>
        .hidden{
            display: none;
        }
    </style>
    <h3>Proof {{ object.pk }}</h3>
    <hr>
    <form action="" method="post">
        <div>
            {% csrf_token %}
            {{ form.as_table }}
        </div>
        <hr>
        <button id="add-more" type="button">Add Proof Line</button>
        <hr>
        {% if formset %}
            {{ formset.management_form }}
            <div id="proof-line-list">
                {% for f in formset %}
                    {% if not f.DELETE.value %}
                        <div class="proofline-form" id="proofline-form-{{ forloop.counter0 }}">
                            {{ f.as_table }}
                            <input class="insert-row" type="button" id="id-form-btn-insert-row-{{ forloop.counter0 }}" value="Insert Row" onclick="add_new_form(this)">
                            <input class="delete-row" type="button" id="id-form-btn-delete-row-{{ forloop.counter0 }}" value="Delete" onclick="removeProofline(this)">
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            <div id="empty-form" class="hidden">
                {{ formset.empty_form }}
                <input class="insert-row" type="button" id="id-form-btn-insert-row-__prefix__" value="Insert Row" onclick="add_new_form(this)">
                <input class="delete-row" type="button" id="id-form-btn-delete-row-__prefix__" value="Delete" onclick="removeProofline(this)">
            </div>
        {% endif %}
        <hr>

        <input type="text" class="hidden" id="check-proof">
        <button name="check_proof" type="submit">Check Proof</button>
        <button name="submit" type="submit">Save</button>
    </form>

    <hr>
    
    <!-- Display validation errors from form fields-->
    {% for line in formset %}
        {% for field in line %}
            {% if field.errors %}
            <div class="container">
                {% for error in field.errors %}
                <div class="row">
                    {% if line.line_no.value %}
                    <p><strong>Error on line {{line.line_no.value}} field {{ field.label_tag }}</strong> {{ error }}</p>
                    {% else %}
                    <p><strong>Error in field {{ field.label_tag }}</strong> {{ error }}</p>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}
        {% endfor %}
    {% endfor %}

    <!-- Display response from Proof Checker-->
    {% if response %}

    {% if response.err_msg %}
    <p> <strong>Result:</strong> {{ response.err_msg }} </p>
    {% else %}
    <p> <strong>Result:</strong> The proof is valid and complete!</p>
    {% endif %}

    {% endif %}

    <script type="text/javascript">
        const addMoreBtn = document.getElementById("add-more")
        const totalNewForms = document.getElementById("id_form-TOTAL_FORMS")
        const currentProofLineForms = document.getElementsByClassName("proofline-form")
        addMoreBtn.addEventListener("click", add_new_form)


        function add_new_form(button) {

           let currentFormCount = currentProofLineForms.length
           const formCopyTarget = document.getElementById("proof-line-list")

           const emptyFormElement = document.getElementById("empty-form").cloneNode(true)
           emptyFormElement.setAttribute("class", "proofline-form")
           emptyFormElement.setAttribute("id", `proofline-form-${currentFormCount}`)

           const regex = new RegExp('__prefix__', 'g')
           emptyFormElement.innerHTML = emptyFormElement.innerHTML.replace(regex, currentFormCount)
           totalNewForms.setAttribute('value', currentFormCount + 1)
           formCopyTarget.append(emptyFormElement)
        }


        function removeProofline(button) {
           var id = button.id.replace(/[^0-9]/g, "")
           console.log(id)
           const mark_deleted = document.getElementById("id_form-" + id + "-DELETE")
           mark_deleted.setAttribute("checked", "true")
           const targeted_prooflie = document.getElementById("proofline-form-" + id)
           targeted_prooflie.hidden = true
        }

        const inputFields = document.getElementsByClassName("text-replacement-enabled")
        for (let i of inputFields){
            console.log(i)
            i.setAttribute("onkeydown", "replaceCharacter(this);")
        }
    </script>

    {% include 'proofchecker/right_navigation_menu.html' %}
{% endblock %}


{% block js_block %}
    <script type="text/javascript" src="{% static 'js/line_functionality.js' %}"></script>
{% endblock %}
